{% extends "base.html" %}

{% block conteudo %}
    
    <div class="page-header">
        <h2>Itens na Secretaria</h2>
        
        {% if current_user.is_authenticated %}
            <a href="{{ url_for('itens.novo_item') }}" class="btn btn-green">+ Cadastrar Novo Item</a>
        {% endif %}
    </div>

    {% if not itens %}
        <div class="empty-state">
            <p class="empty-text">Nenhum item registrado no momento.</p>
        </div>
    {% else %}
        <div class="table-responsive"> 
            <table>
                <thead>
                    <tr>
                        <th>Descrição</th>
                        <th>Categoria</th>
                        <th>Local Encontrado</th>
                        <th>Data Chegada</th>
                        <th>Situação</th>
                        <th>Ações / Detalhes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in itens %}
                    <tr>
                        <td><strong>{{ item.descricao }}</strong></td>
                        <td>{{ item.categoria }}</td>
                        <td>{{ item.local_encontrado }}</td>
                        <td>{{ item.data_registro.strftime('%d/%m/%Y') }}</td>
                        
                        <td>
                            {% if item.status == 'Ativo' %}
                                <span class="status-badge active">
                                    Na Secretaria
                                </span>
                            {% else %}
                                <span class="status-badge returned">
                                    Devolvido
                                </span>
                            {% endif %}
                        </td>

                        <td>
                            {# VISÃO DO FUNCIONÁRIO (LOGADO) #}
                            {% if current_user.is_authenticated %}
                                
                                {% if item.status == 'Ativo' %}
                                    <form action="{{ url_for('itens.devolver_item', id=item.id) }}" method="POST" class="return-form">
                                        <input type="text" name="nome_retirada" placeholder="Quem recebeu?" required class="return-input">
                                        <button type="submit" class="btn btn-green btn-small" title="Registrar devolução ao dono">
                                            Entregar
                                        </button>
                                    </form>
                                {% else %}
                                    <div class="recipient-info">
                                        Entregue a: <strong>{{ item.retirado_por }}</strong>
                                        <br><small>{{ item.data_devolucao.strftime('%d/%m/%Y') if item.data_devolucao else '' }}</small>
                                    </div>
                                {% endif %}

                                <div class="action-buttons-cell">
                                    <a href="{{ url_for('itens.editar_item', id=item.id) }}" class="btn btn-blue btn-small">Editar</a>

                                    <form action="{{ url_for('itens.remover_item', id=item.id) }}" method="POST" style="display:inline;" onsubmit="return confirm('Tem certeza que deseja apagar este registro permanentemente?');">
                                        <button type="submit" class="btn btn-red btn-small">Excluir</button>
                                    </form>
                                </div>

                            {# VISÃO DO ALUNO/PÚBLICO (NÃO LOGADO) #}
                            {% else %}
                                {% if item.status == 'Devolvido' %}
                                    <span class="status-text-returned">Já foi retirado por: <strong>{{ item.retirado_por }}</strong></span>
                                {% else %}
                                    <span class="status-text-available">
                                        Disponível para retirada. <br>Procure a coordenação.
                                    </span>
                                {% endif %}
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% endif %}

    <div class="back-link-container">
        <a href="{{ url_for('index') }}" class="back-link">&larr; Voltar ao Início</a>
    </div>

{% endblock %}