{% extends "base.html" %}

{% block conteudo %}
    
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>Itens Registrados</h2>
        {% if current_user.is_authenticated %}
            <a href="{{ url_for('itens.novo_item') }}" class="btn btn-green">+ Novo Item</a>
        {% endif %}
    </div>

    {% if not itens %}
        <div style="text-align: center; padding: 20px; background-color: #fff; border-radius: 10px;">
            Nenhum item registrado no momento.
        </div>
    {% else %}
        <div style="overflow-x: auto;"> 
            <table>
                <thead>
                    <tr>
                        <th>Descrição</th>
                        <th>Categoria</th>
                        <th>Local Encontrado</th>
                        <th>Data Registro</th>
                        <th>Status</th>
                        <th>Ações / Detalhes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in itens %}
                    <tr>
                        <td><strong>{{ item.descricao }}</strong></td>
                        <td>{{ item.categoria }}</td>
                        <td>{{ item.local_encontrado }}</td>
                        <td>{{ item.data_registro.strftime('%d/%m/%Y') }}</td>
                        
                        <td>
                            {% if item.status == 'Ativo' %}
                                <span style="color: green; font-weight: bold; background: #e8f5e9; padding: 5px 10px; border-radius: 15px;">Disponível</span>
                            {% else %}
                                <span style="color: #c0392b; font-weight: bold; background: #fadbd8; padding: 5px 10px; border-radius: 15px;">Emprestado</span>
                            {% endif %}
                        </td>

                        <td>
                            {# Lógica para Usuário Logado (Funcionário) #}
                            {% if current_user.is_authenticated %}
                                
                                {% if item.status == 'Ativo' %}
                                    <form action="{{ url_for('itens.devolver_item', id=item.id) }}" method="POST" style="display: flex; gap: 5px; margin-bottom: 10px;">
                                        <input type="text" name="nome_retirada" placeholder="Nome de quem vai pegar" required style="padding: 5px; width: 150px; font-size: 0.85rem;">
                                        <button type="submit" class="btn btn-green" style="padding: 5px 10px; font-size: 0.8rem;">Emprestar</button>
                                    </form>
                                {% else %}
                                    <div style="margin-bottom: 10px; font-size: 0.9rem;">
                                        Está com: <strong>{{ item.retirado_por }}</strong>
                                    </div>
                                {% endif %}

                                <div style="display: flex; gap: 5px; align-items: center;">
                                    <a href="{{ url_for('itens.editar_item', id=item.id) }}" class="btn btn-blue" style="padding: 5px 10px; font-size: 0.8rem;">Editar</a>

                                    <form action="{{ url_for('itens.remover_item', id=item.id) }}" method="POST" style="display:inline;" onsubmit="return confirm('Tem certeza que deseja excluir?');">
                                        <button type="submit" class="btn btn-red" style="padding: 5px 10px; font-size: 0.8rem;">Excluir</button>
                                    </form>
                                </div>

                            {# Lógica para Visitante (Público) #}
                            {% else %}
                                {% if item.status == 'Emprestado' or item.status == 'Devolvido' %}
                                    <span style="color: #c0392b;">Está com: <strong>{{ item.retirado_por }}</strong></span>
                                {% else %}
                                    <span style="color: #f5821f;">Disponível na Secretaria</span>
                                {% endif %}
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% endif %}

    <div style="margin-top: 20px;">
        <a href="{{ url_for('index') }}" style="color: #666; text-decoration: none;">&larr; Voltar ao Início</a>
    </div>

{% endblock %}